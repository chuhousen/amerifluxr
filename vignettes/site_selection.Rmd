---
title: "Site selection"
author: "Housen Chu"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Site selection}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, warning = FALSE}
library(amerifluxr)
library(data.table)
library(pander)
```

amerifluxr is a programmatic interface to the [AmeriFlux](https://ameriflux.lbl.gov/). This vignette demonstrates examples to query a list of target sites based on sites' general information and availability of metadata and data.    

## Get a site list with general info

A full list of AmeriFlux sites with general info can be obtained using the amf_site_info() function. Convert the site list to a data.table for easier manipulation.

```{r echo=TRUE, results = "asis"}
# get a full list of sites with general info
sites <- amf_site_info()
sites_dt <- data.table::as.data.table(sites)

pander::pandoc.table(sites_dt[c(1:3), ])

```

Select sites based on general info, e.g., IGBP, data availability, geo-location. 

```{r results = "asis"}
# get a summary table of sites grouped by IGBP
pander::pandoc.table(sites_dt[, .N, by = "IGBP"])

# get a summary table of sites with available data, & grouped by IGBP
pander::pandoc.table(sites_dt[!is.na(DATA_START), .N, by = "IGBP"])

# get a list of cropland and grassland sites with available data, located within 30-50 degree N in latitude
crop_ls <- sites_dt[IGBP %in% c("CRO", "GRA") &
                                           !is.na(DATA_START) &
                                           LOCATION_LAT > 30 &
                                           LOCATION_LAT < 50,
                                         .(SITE_ID, SITE_NAME, DATA_START, DATA_END)]
pander::pandoc.table(crop_ls[c(1:10), ])

```

## Get metadata availability

In some cases, users may want to know if certain types of metadata are available for the selected sites. The amf_list_metadata() function provides a quick summary of metadata availability before actually downloading the data & metadata through AmeriFlux. By default, amf_list_metadata() returns a full site list with the available entries (i.e., counts) for all BADM groups. Check [AmeriFlux webpage](https://ameriflux.lbl.gov/data/badm/badm-basics/) for definitions of BADM groups.     

```{r results = "asis"}
metadata_aval <- data.table::as.data.table(amf_list_metadata())
pander::pandoc.table(metadata_aval[c(1:3), c(1:10)])
```

The site_set parameter of the amf_list_metadata() can be used to subset the sites of interest.

```{r results = "asis"}
metadata_aval_sub <- as.data.table(amf_list_metadata(site_set = crop_ls$SITE_ID))

# down-select cropland & grassland sites based on the interested BADM group, e.g., canopy height (GRP_HEIGHTC)
crop_ls2 <- metadata_aval_sub[GRP_HEIGHTC > 0, .(SITE_ID, GRP_HEIGHTC)][order(-GRP_HEIGHTC)]
pander::pandoc.table(crop_ls2[c(1:10), ])
```

## Get data availability

In addition, users can use amf_list_data() function to query the availability of specific variables in the data. The amf_list_data() functions provide a quick summary of variable availability (per site/year) before downloading the data through AmeriFlux. By default, amf_list_data() returns a full site list of variable availability (per year) for all variables. The site_set parameter of amf_list_data() can be used to subset the sites of interest. 

```{r results = "asis"}
data_aval <- data.table::as.data.table(amf_list_data(site_set = crop_ls2$SITE_ID))
pander::pandoc.table(data_aval[c(1:10), ])
```

The variable availability can be used to subset sites that have certain variables in specific years. The BASENAME column in the variable availability indicates the variable's base name (i.e., ignoring position qualifier), and can be used to get a coarse-level variable availability. See [AmeriFlux website](https://ameriflux.lbl.gov/data/aboutdata/data-variables/) for definitions of base names and qualifiers.

```{r results = "asis"}
# down-select cropland & grassland sites based on the available wind speed (WS) and 
# friction velocity (USTAR) data in 2015-2018
data_aval_sub <- data_aval[data_aval$BASENAME %in% c("WS","USTAR"),
                           .(SITE_ID, BASENAME, Y2015, Y2016, Y2017, Y2018)]

# calculate mean availability of WS and USTAR in each site and each year
data_aval_sub <- data_aval_sub[, lapply(.SD, mean), 
                               by = .(SITE_ID),
                               .SDcols = c("Y2015", "Y2016", "Y2017", "Y2018")]

# sub-select sites that have WS and USTAR data during any periods of 2015-2018
crop_ls3 <- data_aval_sub[(Y2015 + Y2016 + Y2017 + Y2018) > 0]
pander::pandoc.table(crop_ls3)

```

Last, sometimes users would look for sites with multiple measurements of similar variables (e.g., multilevel wind speed). The VARIABLE column in the variable availability can be used to get a fine-level variable availability.

```{r results = "asis"}
# down-select cropland & grassland sites based on the available wind speed (WS) data,
#  mean availability of WS during 2015-2018
data_aval_sub2 <- data_aval[data_aval$BASENAME %in% c("WS"),
                            .(SITE_ID, VARIABLE, Y2015_2018 = (Y2015 + Y2016 + Y2017 + Y2018)/4)]

# calculate number of WS variables per site, for sites that have any WS data during 2015-2018
data_aval_sub2 <- data_aval_sub2[Y2015_2018 > 0, .(.N, Y2015_2018 = mean(Y2015_2018)), .(SITE_ID)]
pander::pandoc.table(crop_ls4 <- data_aval_sub2[N > 1, ])

```


